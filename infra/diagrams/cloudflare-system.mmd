flowchart LR
  user[End User]
  admin[Admin User]
  idp[Enterprise IdP<br/>OIDC/SAML]
  access[Cloudflare Access]
  pages[Cloudflare Pages<br/>Admin Dashboard]
  api[API Worker<br/>Query + Metrics + AuthZ]
  queue[Cloudflare Queues]
  ingest[Ingest Worker / Consumer]
  r2[(R2<br/>Documents)]
  vec[(Vectorize<br/>Embeddings Index)]
  d1[(D1<br/>Tenant + Audit + Metadata)]
  kv[(KV<br/>Cache + Flags)]
  do[(Durable Objects<br/>Rate Limiter)]
  llm[Model Provider<br/>Chat + Embeddings]
  logs[Logs/Analytics]

  user --> access
  admin --> access
  access --> idp
  access --> pages
  access --> api

  pages --> api

  api --> do
  api --> kv
  api --> d1
  api --> vec
  api --> llm
  api --> logs

  admin -->|Upload docs| api
  api --> r2
  api -. enqueue .-> queue
  queue -. consume .-> ingest
  ingest --> r2
  ingest --> llm
  ingest --> vec
  ingest --> d1
  ingest --> logs

  vec --> api
  d1 --> pages
  d1 --> api

  subgraph legend[Legend]
    l1[Cloudflare Managed]
    l2[External Provider]
    l3[Human Actor]
    l4[Cloudflare Security Control]
  end

  classDef cf fill:#FFF4E5,stroke:#F97316,stroke-width:1.5px,color:#7C2D12;
  classDef cfSec fill:#FFE8D6,stroke:#EA580C,stroke-width:2.5px,color:#7C2D12;
  classDef ext fill:#EEF2FF,stroke:#4F46E5,stroke-width:1.5px,color:#1E1B4B;
  classDef human fill:#F3F4F6,stroke:#6B7280,stroke-width:1.5px,color:#111827;

  class api,pages,ingest,queue,r2,vec,d1,kv,logs cf;
  class access,do cfSec;
  class idp,llm ext;
  class user,admin human;
  class l1 cf;
  class l2 ext;
  class l3 human;
  class l4 cfSec;
