flowchart LR
  user[End User]
  admin[Admin User]
  idp[Enterprise IdP<br/>OIDC/SAML]
  access[Cloudflare Access]
  pages[Cloudflare Pages<br/>Admin Dashboard]
  api[API Worker<br/>Query + Metrics + AuthZ]
  queue[Cloudflare Queues]
  ingest[Ingest Worker / Consumer]
  r2[(R2<br/>Documents)]
  vec[(Vectorize<br/>Embeddings Index)]
  d1[(D1<br/>Tenant + Audit + Metadata)]
  kv[(KV<br/>Cache + Flags)]
  do[(Durable Objects<br/>Rate Limiter)]
  llm[Model Provider<br/>Chat + Embeddings]
  logs[Logs/Analytics]

  user --> access
  admin --> access
  access --> idp
  access --> pages
  access --> api

  pages --> api

  api --> do
  api --> kv
  api --> d1
  api --> vec
  api <--> llm
  api --> logs

  admin -->|Upload docs| api
  api --> r2
  api -. enqueue .-> queue
  queue -. consume .-> ingest
  ingest --> r2
  ingest <--> llm
  ingest --> vec
  ingest --> d1
  ingest --> logs

  vec --> api
  d1 --> api

  subgraph legend[Legend]
    l1[Users]
    l2[Identity]
    l3[Compute]
    l4[Data]
    l5[AI]
    l6[Observability]
  end

  classDef users fill:#FFF4E5,stroke:#B65A00,stroke-width:1.5px,color:#2D1B00;
  classDef identity fill:#E8F1FF,stroke:#2A66B7,stroke-width:1.5px,color:#0E2A57;
  classDef compute fill:#E9FBEF,stroke:#1F7A3F,stroke-width:1.5px,color:#0D3B1E;
  classDef data fill:#F2ECFF,stroke:#6B46C1,stroke-width:1.5px,color:#2E1760;
  classDef ai fill:#FFECEE,stroke:#C53030,stroke-width:1.5px,color:#5C1A1A;
  classDef ops fill:#F3F4F6,stroke:#4B5563,stroke-width:1.5px,color:#111827;

  class user,admin users;
  class idp,access identity;
  class api,pages,ingest,queue,do compute;
  class r2,vec,d1,kv data;
  class llm ai;
  class logs ops;
  class l1 users;
  class l2 identity;
  class l3 compute;
  class l4 data;
  class l5 ai;
  class l6 ops;
